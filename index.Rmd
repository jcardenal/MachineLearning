---
title: "Machine Learning Course"
author: "jcardenal"
date: "21/12/2014"
output: html_document
---

In order to answer the questions of this exercise, we begin loading the required packages (_caret_) and the training data (file _pml-training.csv_) taking care of some values in the file to be considered as _NA_.
 
```{r, echo=TRUE}
library(caret)
data <- read.csv("pml-training.csv",na.strings=c("","NA","#DIV/0!"))
str(data)
```
# Data Cleaning

From the paper http://groupware.les.inf.puc-rio.br/public/papers/2013.Velloso.QAR-WLE.pdf, the experiment uses 4 sensors providing acceleration, gyroscope and magnetometer data, located on the arm-band, belt and glove (forearm) of the person and one on the dumbbell. These are the only predictors to be considered.

```{r, echo=TRUE}
consider <- c(grep("accel_(*)", names(data),value=TRUE), grep("gyros_(*)", names(data),value=TRUE), grep("magnet_(*)",names(data),value=T),"classe")

cleanData <- data[,consider]
```
Now we can eliminate rows not completed:

```{r, echo=TRUE}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cleanData <- cleanData[complete.cases(cleanData),]
```

Now, we can consider how to diminish the number of predictors to be used in the model, keeping the variability of the data. We can use _nearZeroVar_ function to identify zero covariates to remove:

```{r, echo=TRUE}
nsv <- nearZeroVar(cleanData, saveMetrics=TRUE)
zeroCov <- nsv[nsv$zeroVar & nsv$nzv,]
zeroCov
```
As shown, no more columns can be ommited.


And finally, columns starting with *"var_"* can also be removed

```{r, echo=TRUE}

consider <- setdiff(consider,grep("^var*",consider,value=TRUE))

cleanData <- cleanData[,consider]
```




# Model Building 

In order to be able to estimate the error of the proposed model, we can partition the data set in two: the _training_ and _testing_ data.

```{r, echo=TRUE}
inTrain <- createDataPartition(y=cleanData$classe, p=0.75, list=FALSE)
training <- cleanData[inTrain,]
testing <- cleanData[-inTrain,]
```

In order to build the model, we use the _Random Forest_ model, as we are interested in a classification model.

```{r, echo=TRUE}

modelFit <- train(training$classe ~ ., method= "rf",data=training, prox=TRUE)
modelFit
```
Now we can test the model with the testing data set, comparing real testing data with predictions:

```{r, echo=TRUE}

pred <- predict(modelFit, testing)
testing$predRight <- pred == testing$classe
table(pred,testing$classe)

```

As we can see, the model is far from perfect, but is good enough for our purposes

# Final Step

Now is time to load the data requiring the predictions, _pml-testing.csv_ , not used during model building:

```{r, echo=TRUE}

newData <- read.csv("pml-testing.csv",na.strings=c("","NA","#DIV/0!"))
newData$pred <- predict(modelFit, newData)
newData[,c("problem_id","pred")]
```